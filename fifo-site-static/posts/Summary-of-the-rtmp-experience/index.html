<!DOCTYPE html>









<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh-CN"
  
>

  <!--
  The Head
-->

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TDXWE8K8LF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-TDXWE8K8LF');
  </script>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="RTMP直播协议实践经验总结" />
<meta name="author" content="zhaoyou" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="2018年8月4日第三次更新，详细介绍了RTMP协议与遇到的坑，另外纯Java重写了RTMP协议，做了个Android 推流项目，包含安卓相机采集，编码和RTMP推流，上传到github了。 项目地址：https://github.com/gezhaoyou/SimpleLivePublisherLite 参考文章：" />
<meta property="og:description" content="2018年8月4日第三次更新，详细介绍了RTMP协议与遇到的坑，另外纯Java重写了RTMP协议，做了个Android 推流项目，包含安卓相机采集，编码和RTMP推流，上传到github了。 项目地址：https://github.com/gezhaoyou/SimpleLivePublisherLite 参考文章：" />
<link rel="canonical" href="https://fifo.site/posts/Summary-of-the-rtmp-experience/" />
<meta property="og:url" content="https://fifo.site/posts/Summary-of-the-rtmp-experience/" />
<meta property="og:site_name" content="拙巧匠" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-05T14:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="RTMP直播协议实践经验总结" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@zhaoyou" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"zhaoyou"},"dateModified":"2021-01-05T14:00:00+08:00","datePublished":"2021-01-05T14:00:00+08:00","description":"2018年8月4日第三次更新，详细介绍了RTMP协议与遇到的坑，另外纯Java重写了RTMP协议，做了个Android 推流项目，包含安卓相机采集，编码和RTMP推流，上传到github了。 项目地址：https://github.com/gezhaoyou/SimpleLivePublisherLite 参考文章：","headline":"RTMP直播协议实践经验总结","mainEntityOfPage":{"@type":"WebPage","@id":"https://fifo.site/posts/Summary-of-the-rtmp-experience/"},"url":"https://fifo.site/posts/Summary-of-the-rtmp-experience/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>RTMP直播协议实践经验总结 |  拙巧匠</title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="拙巧匠">
<meta name="application-name" content="拙巧匠">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script>

  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get MODE_ATTR() { return "data-mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  
</head>


  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" class="mx-auto">
        
          
          <img src="/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title">
      <a href="/">拙巧匠</a>
    </div>
    <div class="site-subtitle font-italic">关注音视频开发的个人博客！</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>首页</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>分类</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>标签</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>归档</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>关于</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    
      <button class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
      <a href="https://github.com/gezhaoyou" aria-label="github"
        
        
          
          target="_blank"
        

        

        rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/" aria-label="twitter"
        
        
          
          target="_blank"
        

        

        rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['gezhoayou','126.com'].join('@')" aria-label="email"
        
        

        

        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        
        

        

        >
        <i class="fas fa-rss"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              首页
            </a>
          </span>

        

      

        

      

        

          
            <span>RTMP直播协议实践经验总结</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      文章
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="搜索...">
    </span>
    <span id="search-cancel" >取消</span>
  </div>

</div>


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container pl-xl-4 pr-xl-4">
        





<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4">
    <div class="post pl-1 pr-1 pl-md-2 pr-md-2">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->


<!-- images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







<!-- return -->

<h1 data-toc-skip>RTMP直播协议实践经验总结</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      发表于
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class=""
    data-ts="1609826400"
    data-df="YYYY/MM/DD"
    data-toggle="tooltip" data-placement="bottom">
  2021/01/05
</em>

    </span>

    <!-- lastmod date -->
    

  

  <div class="d-flex justify-content-between">
    <!-- author(s) -->
    <span>
      

      作者

      <em>
      
        
          <a href=""></a>
          
        
      
      </em>
    </span>

    <div>
      <!-- page views -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="7086 字">
  <em>39 分钟</em>阅读</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>2018年8月4日第三次更新，详细介绍了RTMP协议与遇到的坑，另外纯Java重写了RTMP协议，做了个Android 推流项目，包含安卓相机采集，编码和RTMP推流，上传到github了。
项目地址：<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fgezhaoyou%2FSimpleLivePublisherLite">https://github.com/gezhaoyou/SimpleLivePublisherLite</a>
参考文章：</p>

<blockquote>
  <ol>
    <li>Android RTMP直播推流Demo： https://www.jianshu.com/p/0318ff29ac32</li>
    <li>带你吃透RTMP：<a href="https://links.jianshu.com/go?to=http%3A%2F%2Fmingyangshang.github.io%2F2016%2F03%2F06%2FRTMP%E5%8D%8F%E8%AE%AE%2F">http://mingyangshang.github.io/2016/03/06/RTMP%E5%8D%8F%E8%AE%AE/</a></li>
  </ol>
</blockquote>

<h3 id="1-简介"><span class="mr-2"><strong>1.</strong> <strong>简介</strong></span><a href="#1-简介" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>RTMP协议是<code class="language-plaintext highlighter-rouge">Real Time Message Protocol</code>(实时信息传输协议)的缩写，它是由Adobe公司提出的一种应用层的协议，用来解决多媒体数据传输流的多路复用（Multiplexing）和分包（packetizing）的问题。随着VR技术的发展，视频直播等领域逐渐活跃起来，RTMP作为业内广泛使用的协议也重新被相关开发者重视起来。本文主要分享对RTMP的一些简介和实际开发中遇到的一些状况。</p>

<p><strong>RTMP协议基本特点：</strong></p>

<p>• 基于<code class="language-plaintext highlighter-rouge">TCP</code>协议的应用层协议</p>

<p>• 默认通信端口<code class="language-plaintext highlighter-rouge">1935</code></p>

<p><strong>RTMP URL格式：</strong>
<code class="language-plaintext highlighter-rouge">rtmp://ip:[port]/appName/streamName</code>
例如： <code class="language-plaintext highlighter-rouge">rtmp://192.168.178.218:1935/live/devzhaoyou</code></p>

<blockquote>
  <p>参考：<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Fai2000ai%2Farticle%2Fdetails%2F72771461">https://blog.csdn.net/ai2000ai/article/details/72771461</a></p>
</blockquote>

<h3 id="2-rtmp-握手"><span class="mr-2">2. <strong>RTMP 握手</strong></span><a href="#2-rtmp-握手" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><code class="language-plaintext highlighter-rouge">RTMP</code> 握手分为简单握手和复杂握手，现在<code class="language-plaintext highlighter-rouge">Adobe</code>公司使用<code class="language-plaintext highlighter-rouge">RTMP</code>协议的产品用复杂握手的较多，不做介绍。</p>

<h3 id="握手包格式"><span class="mr-2"><strong>握手包格式：</strong></span><a href="#握手包格式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span>
<span class="o">+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>     <span class="n">version</span>   <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+</span>
 <span class="no">C0</span> <span class="n">and</span> <span class="no">S0</span> <span class="n">bits</span>
</pre></td></tr></tbody></table></code></div></div>

<p>C0和S0：<code class="language-plaintext highlighter-rouge">1</code>个字节，包含了RTMP版本, 当前RTMP协议的版本为 <code class="language-plaintext highlighter-rouge">3</code></p>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre> <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
 <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                           <span class="n">time</span> <span class="p">(</span><span class="mi">4</span> <span class="n">bytes</span><span class="p">)</span>                      <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                           <span class="n">zero</span> <span class="p">(</span><span class="mi">4</span> <span class="n">bytes</span><span class="p">)</span>                      <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                           <span class="n">random</span> <span class="n">bytes</span>                        <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                           <span class="n">random</span> <span class="n">bytes</span>                        <span class="o">|</span>
<span class="o">|</span>                               <span class="p">(</span><span class="n">cont</span><span class="p">)</span>                          <span class="o">|</span>
<span class="o">|</span>                               <span class="o">....</span>                            <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
                        <span class="no">C1</span> <span class="n">and</span> <span class="no">S1</span> <span class="n">bits</span>
</pre></td></tr></tbody></table></code></div></div>

<p>C1和S1：<code class="language-plaintext highlighter-rouge">4</code>字节时间戳，<code class="language-plaintext highlighter-rouge">4</code>字节的<code class="language-plaintext highlighter-rouge">0</code>，<code class="language-plaintext highlighter-rouge">1528</code>字节的随机数</p>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>  <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
  <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>                          <span class="n">time</span> <span class="p">(</span><span class="mi">4</span> <span class="n">bytes</span><span class="p">)</span>                       <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>                          <span class="n">time2</span> <span class="p">(</span><span class="mi">4</span> <span class="n">bytes</span><span class="p">)</span>                      <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>                          <span class="n">random</span> <span class="n">echo</span>                          <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>                          <span class="n">random</span> <span class="n">echo</span>                          <span class="o">|</span>
 <span class="o">|</span>                             <span class="p">(</span><span class="n">cont</span><span class="p">)</span>                            <span class="o">|</span>
 <span class="o">|</span>                              <span class="o">....</span>                             <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
                            <span class="no">C2</span> <span class="n">and</span> <span class="no">S2</span> <span class="n">bits</span>
</pre></td></tr></tbody></table></code></div></div>

<p>C2和S2：<code class="language-plaintext highlighter-rouge">4</code>字节时间戳，<code class="language-plaintext highlighter-rouge">4</code>字节从对端读到的时间戳，<code class="language-plaintext highlighter-rouge">1528</code>字节随机数</p>

<h3 id="rtmp握手基本过程"><span class="mr-2"><strong>RTMP握手基本过程：</strong></span><a href="#rtmp握手基本过程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="o">+-------------+</span>                            <span class="o">+-------------+</span>
<span class="o">|</span>   <span class="no">Client</span>    <span class="o">|</span>      <span class="no">TCP</span><span class="o">/</span><span class="no">IP</span> <span class="no">Network</span>        <span class="o">|</span>     <span class="no">Server</span>  <span class="o">|</span>
<span class="o">+-------------+</span>             <span class="o">|</span>              <span class="o">+-------------+</span>
       <span class="o">|</span>                    <span class="o">|</span>                     <span class="o">|</span>
<span class="no">Uninitialized</span>               <span class="o">|</span>                <span class="no">Uninitialized</span>
       <span class="o">|</span>        <span class="no">C0</span>          <span class="o">|</span>                     <span class="o">|</span>
       <span class="o">|-------------------&gt;|</span>           <span class="no">C0</span>        <span class="o">|</span>
       <span class="o">|</span>                    <span class="o">|--------------------&gt;|</span>
       <span class="o">|</span>        <span class="no">C1</span>          <span class="o">|</span>                     <span class="o">|</span>
       <span class="o">|-------------------&gt;|</span>           <span class="no">S0</span>        <span class="o">|</span>
       <span class="o">|</span>                    <span class="o">|&lt;--------------------|</span>
       <span class="o">|</span>                    <span class="o">|</span>           <span class="no">S1</span>        <span class="o">|</span>
  <span class="no">Version</span> <span class="n">sent</span>              <span class="o">|&lt;--------------------|</span>
       <span class="o">|</span>        <span class="no">S0</span>          <span class="o">|</span>                     <span class="o">|</span>
       <span class="o">|&lt;-------------------|</span>                     <span class="o">|</span>
       <span class="o">|</span>        <span class="no">S1</span>          <span class="o">|</span>                     <span class="o">|</span>
       <span class="o">|&lt;-------------------|</span>               <span class="no">Version</span> <span class="n">sent</span>
       <span class="o">|</span>                    <span class="o">|</span>           <span class="no">C1</span>        <span class="o">|</span>
       <span class="o">|</span>                    <span class="o">|--------------------&gt;|</span>
       <span class="o">|</span>        <span class="no">C2</span>          <span class="o">|</span>                     <span class="o">|</span>
       <span class="o">|-------------------&gt;|</span>           <span class="no">S2</span>        <span class="o">|</span>
       <span class="o">|</span>                    <span class="o">|&lt;--------------------|</span>
    <span class="no">Ack</span> <span class="n">sent</span>                <span class="o">|</span>                   <span class="no">Ack</span> <span class="no">Sent</span>
       <span class="o">|</span>        <span class="no">S2</span>          <span class="o">|</span>                     <span class="o">|</span>
       <span class="o">|&lt;-------------------|</span>                     <span class="o">|</span>
       <span class="o">|</span>                    <span class="o">|</span>           <span class="no">C2</span>        <span class="o">|</span>
       <span class="o">|</span>                    <span class="o">|--------------------&gt;|</span>
<span class="no">Handshake</span> <span class="no">Done</span>              <span class="o">|</span>               <span class="no">Handshake</span> <span class="no">Done</span>
      <span class="o">|</span>                     <span class="o">|</span>                     <span class="o">|</span>
          <span class="no">Pictorial</span> <span class="no">Representation</span> <span class="n">of</span> <span class="no">Handshake</span>
</pre></td></tr></tbody></table></code></div></div>

<p>握手开始于客户端发送<code class="language-plaintext highlighter-rouge">C0</code>、<code class="language-plaintext highlighter-rouge">C1</code>块。服务器收到<code class="language-plaintext highlighter-rouge">C0</code>或<code class="language-plaintext highlighter-rouge">C1</code>后发送<code class="language-plaintext highlighter-rouge">S0</code>和<code class="language-plaintext highlighter-rouge">S1</code>。</p>

<p>当客户端收齐<code class="language-plaintext highlighter-rouge">S0</code>和<code class="language-plaintext highlighter-rouge">S1</code>后，开始发送<code class="language-plaintext highlighter-rouge">C2</code>。当服务器收齐<code class="language-plaintext highlighter-rouge">C0</code>和<code class="language-plaintext highlighter-rouge">C1</code>后，开始发送<code class="language-plaintext highlighter-rouge">S2</code>。</p>

<p>当客户端和服务器分别收到<code class="language-plaintext highlighter-rouge">S2</code>和<code class="language-plaintext highlighter-rouge">C2</code>后，握手完成。</p>

<p><strong>注意事项：</strong> 在实际工程应用中，一般是客户端先将<code class="language-plaintext highlighter-rouge">C0</code>, <code class="language-plaintext highlighter-rouge">C1</code>块同时发出，服务器在收到<code class="language-plaintext highlighter-rouge">C1</code> 之后同时将<code class="language-plaintext highlighter-rouge">S0</code>, <code class="language-plaintext highlighter-rouge">S1</code>, <code class="language-plaintext highlighter-rouge">S2</code>发给客户端。<code class="language-plaintext highlighter-rouge">S2</code>的内容就是收到的<code class="language-plaintext highlighter-rouge">C1</code>块的内容。之后客户端收到<code class="language-plaintext highlighter-rouge">S1</code>块，并原样返回给服务器，简单握手完成。按照RTMP协议个要求，客户端需要校验<code class="language-plaintext highlighter-rouge">C1</code>块的内容和<code class="language-plaintext highlighter-rouge">S2</code>块的内容是否相同，相同的话才彻底完成握手过程，实际编写程序用一般都不去做校验。</p>

<p>RTMP握手的这个过程就是完成了两件事：</p>

<p>校验客户端和服务器端RTMP协议版本号</p>

<p>是发了一堆随机数据，校验网络状况。</p>

<h3 id="3-rtmp-消息"><span class="mr-2"><strong>3</strong>. RTMP 消息</span><a href="#3-rtmp-消息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>RTMP消息格式：</p>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>  <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
  <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span> <span class="no">Message</span> <span class="no">Type</span> <span class="o">|</span>               <span class="no">Payload</span> <span class="n">length</span>                   <span class="o">|</span>
 <span class="o">|</span>   <span class="p">(</span><span class="mi">1</span> <span class="n">byte</span><span class="p">)</span>   <span class="o">|</span>                   <span class="p">(</span><span class="mi">3</span> <span class="n">bytes</span><span class="p">)</span>                    <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>                          <span class="no">Timestamp</span>                            <span class="o">|</span>
 <span class="o">|</span>                          <span class="p">(</span><span class="mi">4</span> <span class="n">bytes</span><span class="p">)</span>                            <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>                          <span class="no">Stream</span> <span class="no">ID</span>            <span class="o">|</span>
 <span class="o">|</span>                          <span class="p">(</span><span class="mi">3</span> <span class="n">bytes</span><span class="p">)</span>            <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
                         <span class="no">Message</span> <span class="no">Header</span>
</pre></td></tr></tbody></table></code></div></div>

<p>• 1字节消息类型</p>

<p>• 3字节负载消息长度</p>

<p>• 4字节时间戳</p>

<p>• 3字节 <code class="language-plaintext highlighter-rouge">Stream ID</code>，区分消息流</p>

<p><strong>注意事项：</strong> 实际RTMP通信中并未按照上述格式去发送RTMP消息，而是将RTMP 消息分块发送，之后将介绍RTMP消息分块。</p>

<h4 id="rtmp-消息分块chunking"><span class="mr-2">RTMP 消息分块（chunking）</span><a href="#rtmp-消息分块chunking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>而对于基于<code class="language-plaintext highlighter-rouge">TCP</code>的<code class="language-plaintext highlighter-rouge">RTMP</code>协议而言，协议显得特别繁琐，但是有没有更好的替代方案。同时创建<code class="language-plaintext highlighter-rouge">RTMP</code>消息分块是比较复杂的地方，涉及到了<code class="language-plaintext highlighter-rouge">AFM</code>（也是<code class="language-plaintext highlighter-rouge">Adobe</code>家的东西）格式数据的数据。</p>

<h4 id="31rtmp消息块格式"><span class="mr-2"><strong>3.1RTMP消息块格式：</strong></span><a href="#31rtmp消息块格式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre> <span class="o">+--------------+----------------+--------------------+--------------+</span>
 <span class="o">|</span> <span class="no">Basic</span> <span class="no">Header</span> <span class="o">|</span> <span class="no">Message</span> <span class="no">Header</span> <span class="o">|</span> <span class="no">Extended</span> <span class="no">Timestamp</span> <span class="o">|</span>  <span class="no">Chunk</span> <span class="no">Data</span>  <span class="o">|</span>
 <span class="o">+--------------+----------------+--------------------+--------------+</span>
 <span class="o">|</span>                                                    <span class="o">|</span>
 <span class="o">|&lt;-------------------</span> <span class="no">Chunk</span> <span class="no">Header</span> <span class="o">-----------------&gt;|</span>
                            <span class="no">Chunk</span> <span class="no">Format</span>
</pre></td></tr></tbody></table></code></div></div>

<p>RTMP消息块构成：</p>

<p>• Basic Header</p>

<p>• Message Header</p>

<p>• Extended Timestamp</p>

<p>• Chunk Data</p>

<p>Chunk Basic header格式有3种:</p>

<p>格式1：</p>

<div class="language-objectivec highlighter-rouge"><div class="code-header">
        <span data-label-text="Objective-C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>   <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span>
  <span class="o">+-+-+-+-+-+-+-+-+</span>
  <span class="o">|</span><span class="n">fmt</span><span class="o">|</span>   <span class="n">cs</span> <span class="n">id</span>   <span class="o">|</span>
  <span class="o">+-+-+-+-+-+-+-+-</span><span class="k">+</span>
 <span class="n">Chunk</span> <span class="n">basic</span> <span class="n">header</span> <span class="mi">1</span>
</pre></td></tr></tbody></table></code></div></div>

<p>格式2：</p>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>  <span class="mi">0</span>                      <span class="mi">1</span>
  <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span><span class="n">fmt</span><span class="o">|</span>      <span class="mi">0</span>    <span class="o">|</span>  <span class="n">cs</span> <span class="nb">id</span> <span class="o">-</span> <span class="mi">64</span>   <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
      <span class="no">Chunk</span> <span class="n">basic</span> <span class="n">header</span> <span class="mi">2</span>
</pre></td></tr></tbody></table></code></div></div>

<p>格式3：</p>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span><span class="n">fmt</span><span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>          <span class="n">cs</span> <span class="nb">id</span> <span class="o">-</span> <span class="mi">64</span>           <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
             <span class="no">Chunk</span> <span class="n">basic</span> <span class="n">header</span> <span class="mi">3</span>
</pre></td></tr></tbody></table></code></div></div>

<p>注意事项：</p>

<p><strong>fmt</strong>: 用于指定<code class="language-plaintext highlighter-rouge">Chunk Header</code> 里面 <code class="language-plaintext highlighter-rouge">Message Header</code>的类型，后面会介绍到</p>

<p><strong>cs id</strong>: 是<code class="language-plaintext highlighter-rouge">chunk stream id</code>的缩写，同一个<code class="language-plaintext highlighter-rouge">RTMP</code>消息拆成的 <code class="language-plaintext highlighter-rouge">chunk</code> 块拥有相同的 <code class="language-plaintext highlighter-rouge">cs id</code>, 用于区分chunk所属的RTMP消息, <code class="language-plaintext highlighter-rouge">chunk basic header</code> 的类型<code class="language-plaintext highlighter-rouge">cs id</code>占用的字节数来确定</p>

<h5 id="message-header格式"><span class="mr-2"><strong>Message Header格式：</strong></span><a href="#message-header格式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>Message Header的类型通过上文<code class="language-plaintext highlighter-rouge">chunk basic header</code>中的<code class="language-plaintext highlighter-rouge">fmt</code>指定，共4种:</p>

<p>格式0:</p>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>  <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
  <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>                          <span class="n">timestamp</span>            <span class="o">|</span> <span class="n">message</span> <span class="n">length</span><span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>      <span class="n">message</span> <span class="n">length</span> <span class="p">(</span><span class="n">cont</span><span class="p">)</span>    <span class="o">|</span><span class="n">message</span> <span class="n">type</span> <span class="nb">id</span><span class="o">|</span> <span class="n">msg</span> <span class="n">stream</span> <span class="nb">id</span> <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>          <span class="n">message</span> <span class="n">stream</span> <span class="nb">id</span> <span class="p">(</span><span class="n">cont</span><span class="p">)</span>             <span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
                <span class="no">Chunk</span> <span class="no">Message</span> <span class="no">Header</span> <span class="o">-</span> <span class="no">Type</span> <span class="mi">0</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">Message Header</code>占用<code class="language-plaintext highlighter-rouge">11</code>个字节， 在<code class="language-plaintext highlighter-rouge">chunk stream</code>的开始的第一个<code class="language-plaintext highlighter-rouge">chunk</code>的时候必须采用这种格式。</p>

<p>• <strong>timestamp</strong>：<code class="language-plaintext highlighter-rouge">3</code>个字节，因此它最多能表示到<code class="language-plaintext highlighter-rouge">16777215=0xFFFFFF=2^24-1</code>, 当它的值超过这个最大值时，这三个字节都置为1，实际的<code class="language-plaintext highlighter-rouge">timestamp</code>会转存到<code class="language-plaintext highlighter-rouge">Extended Timestamp</code>字段中，接受端在判断<code class="language-plaintext highlighter-rouge">timestamp</code>字段24个位都为1时就会去<code class="language-plaintext highlighter-rouge">Extended timestamp</code>中解析实际的时间戳。</p>

<p>• <strong>message length</strong>：<code class="language-plaintext highlighter-rouge">3</code>个字节，表示实际发送的消息的数据如音频帧、视频帧等数据的长度，单位是字节。注意这里是Message的长度，也就是chunk属于的Message的总数据长度，而不是chunk本身Data的数据的长度。</p>

<p>• <strong>message type id</strong>：<code class="language-plaintext highlighter-rouge">1</code>个字节，表示实际发送的数据的类型，如<code class="language-plaintext highlighter-rouge">8</code>代表音频数据、<code class="language-plaintext highlighter-rouge">9</code>代表视频数据。</p>

<p>• <strong>msg stream id</strong>：4个字节，表示该chunk所在的流的<code class="language-plaintext highlighter-rouge">ID</code>，和<code class="language-plaintext highlighter-rouge">Basic Header</code>的<code class="language-plaintext highlighter-rouge">CSID</code>一样，它采用小端存储的方式</p>

<p>格式1：</p>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>  <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
  <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>                          <span class="n">timestamp</span>            <span class="o">|</span> <span class="n">message</span> <span class="n">length</span><span class="o">|</span>
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
 <span class="o">|</span>      <span class="n">message</span> <span class="n">length</span> <span class="p">(</span><span class="n">cont</span><span class="p">)</span>    <span class="o">|</span><span class="n">message</span> <span class="n">type</span> <span class="nb">id</span><span class="o">|</span>  
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span> 
                <span class="no">Chunk</span> <span class="no">Message</span> <span class="no">Header</span> <span class="o">-</span> <span class="no">Type</span> <span class="mi">1</span> 
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">Message Header</code>占用7个字节，省去了表示<code class="language-plaintext highlighter-rouge">msg stream id</code>的4个字节，表示此<code class="language-plaintext highlighter-rouge">chunk</code>和上一次发的<code class="language-plaintext highlighter-rouge">chunk</code>所在的流相同。</p>

<p>• <strong>timestamp delta</strong>：3个字节，注意这里和格式0时不同，存储的是和上一个chunk的时间差。类似上面提到的<code class="language-plaintext highlighter-rouge">timestamp</code>，当它的值超过3个字节所能表示的最大值时，三个字节都置为1，实际的时间戳差值就会转存到<code class="language-plaintext highlighter-rouge">Extended Timestamp</code>字段中，接受端在判断<code class="language-plaintext highlighter-rouge">timestamp delta</code>字段24个位都为1时就会去<code class="language-plaintext highlighter-rouge">Extended timestamp</code>中解析时机的与上次时间戳的差值。</p>

<p>格式2：</p>

<div class="language-dart highlighter-rouge"><div class="code-header">
        <span data-label-text="Dart"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>  <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>     
  <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> 
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span> 
 <span class="o">|</span>                          <span class="n">timestamp</span>            <span class="o">|</span>  
 <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span> 
          <span class="n">Chunk</span> <span class="n">Message</span> <span class="n">Header</span> <span class="o">-</span> <span class="kt">Type</span> <span class="mi">2</span> 
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">Message Header</code>占用3个字节，相对于格式1，又省去了表示消息长度的3个字节和表示消息类型的1个字节，表示此chunk和上一次发送的chunk所在的流、消息的长度和消息的类型都相同。余下的这三个字节表示<code class="language-plaintext highlighter-rouge">timestamp delta</code>，使用同格式1。</p>

<p>格式3：</p>

<p>0字节，它表示这个chunk的<code class="language-plaintext highlighter-rouge">Message Header</code>和上一个是完全相同的，无需再次传送</p>

<h5 id="extended-timestamp扩展时间戳"><span class="mr-2"><strong>Extended Timestamp（扩展时间戳）：</strong></span><a href="#extended-timestamp扩展时间戳" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>在<code class="language-plaintext highlighter-rouge">chunk</code>中会有时间戳<code class="language-plaintext highlighter-rouge">timestamp</code>和时间戳差<code class="language-plaintext highlighter-rouge">timestamp delta</code>， 只有这两者之一大于3个字节能表示的最大数值<code class="language-plaintext highlighter-rouge">0xFFFFFF＝16777215</code>时，才会用这个字段来表示真正的时间戳，否则这个字段<strong>不传</strong>（感谢评论区 @<a href="https://www.jianshu.com/u/b400a0703f6e">hijiang</a>指出错误）。</p>

<p>扩展时间戳占<code class="language-plaintext highlighter-rouge">4</code>个字节，能表示的最大数值就是<code class="language-plaintext highlighter-rouge">0xFFFFFFFF＝4294967295</code>。当扩展时间戳启用时，<code class="language-plaintext highlighter-rouge">timestamp</code>字段或者<code class="language-plaintext highlighter-rouge">timestamp delta</code>要全置为<code class="language-plaintext highlighter-rouge">1</code>，表示应该去扩展时间戳字段来提取真正的时间戳或者时间戳差。注意扩展时间戳存储的是完整值，而不是减去时间戳或者时间戳差的值。</p>

<p><strong>Chunk Data（块数据）</strong>： 用户层面上真正想要发送的与协议无关的数据，长度在(0,chunkSize]之间, <code class="language-plaintext highlighter-rouge">chunk size</code>默认为<code class="language-plaintext highlighter-rouge">128</code>字节。</p>

<h5 id="rtmp-消息分块注意事项"><span class="mr-2"><strong>RTMP 消息分块注意事项</strong></span><a href="#rtmp-消息分块注意事项" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>• <strong>Chunk Size</strong>:</p>

<p>RTMP是按照<code class="language-plaintext highlighter-rouge">chunk size</code>进行分块，<code class="language-plaintext highlighter-rouge">chunk size</code> 指的是 <code class="language-plaintext highlighter-rouge">chunk</code>的<code class="language-plaintext highlighter-rouge">payload</code>部分的大小，不包括<code class="language-plaintext highlighter-rouge">chunk basic header</code> 和 <code class="language-plaintext highlighter-rouge">chunk message header</code>长度。客户端和服务器端各自维护了两个<code class="language-plaintext highlighter-rouge">chunk size</code>, 分别是自身分块的<code class="language-plaintext highlighter-rouge">chunk size</code> 和 对端 的<code class="language-plaintext highlighter-rouge">chunk size</code>, 默认的这两个<code class="language-plaintext highlighter-rouge">chunk size</code>都是128字节。通过向对端发送<code class="language-plaintext highlighter-rouge">set chunk size</code> 消息可以告知对方更改了 <code class="language-plaintext highlighter-rouge">chunk size</code>的大小。</p>

<p>• <strong>Chunk Type</strong>:</p>

<p>RTMP消息分成的<code class="language-plaintext highlighter-rouge">Chunk</code>有<code class="language-plaintext highlighter-rouge">4</code>种类型，可以通过 <code class="language-plaintext highlighter-rouge">chunk basic header</code>的高两位(<code class="language-plaintext highlighter-rouge">fmt</code>)指定，一般在拆包的时候会把一个RTMP消息拆成以格式<code class="language-plaintext highlighter-rouge">0</code>开始的<code class="language-plaintext highlighter-rouge">chunk</code>，之后的包拆成格式<code class="language-plaintext highlighter-rouge">3</code> 类型的<code class="language-plaintext highlighter-rouge">chunk</code>，我查看了有不少代码也是这样实现的，这样也是最简单的实现。</p>

<p>如果第二个<code class="language-plaintext highlighter-rouge">message</code>和第一个<code class="language-plaintext highlighter-rouge">message</code>的<code class="language-plaintext highlighter-rouge">message stream ID</code> 相同，并且第二个<code class="language-plaintext highlighter-rouge">message</code>的长度也大于了<code class="language-plaintext highlighter-rouge">chunk size</code>，那么该如何拆包？当时查了很多资料，都没有介绍。后来看了一些源码，如 <code class="language-plaintext highlighter-rouge">SRS</code>，<code class="language-plaintext highlighter-rouge">FFMPEG</code>中的实现，发现第二个<code class="language-plaintext highlighter-rouge">message</code>可以拆成<code class="language-plaintext highlighter-rouge">Type_1</code>类型一个<code class="language-plaintext highlighter-rouge">chunk</code>， <code class="language-plaintext highlighter-rouge">message</code>剩余的部分拆成<code class="language-plaintext highlighter-rouge">Type_3</code>类型的<code class="language-plaintext highlighter-rouge">chunk</code>。<code class="language-plaintext highlighter-rouge">FFMPEG</code>中就是这么做的。</p>

<h4 id="32-rtmp-交互消息"><span class="mr-2">3.2 <strong>RTMP 交互消息</strong></span><a href="#32-rtmp-交互消息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>推流RTMP消息交互流程：</p>

<ul>
  <li>
    <div class="table-wrapper"><table>
      <tbody>
        <tr>
          <td>![img](https://upload-images.jianshu.io/upload_images/1111194-54ff023d7e493ad6.png?imageMogr2/auto-orient/strip</td>
          <td>imageView2/2/w/890/format/webp)</td>
        </tr>
      </tbody>
    </table></div>

    <p>pic_2.png</p>
  </li>
</ul>

<p>关于推流的过程，RTMP的协议文档上给了上图示例，说一下推流注意事项：</p>

<h5 id="321-connect-消息"><span class="mr-2"><strong>3.2.1</strong> <strong>Connect 消息</strong></span><a href="#321-connect-消息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>RTMP 命令消息格式：</p>

<div class="language-ruby highlighter-rouge"><div class="code-header">
        <span data-label-text="Ruby"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre> <span class="o">+----------------+---------+---------------------------------------+</span>
 <span class="o">|</span>  <span class="no">Field</span> <span class="no">Name</span>    <span class="o">|</span>   <span class="no">Type</span>  <span class="o">|</span>               <span class="no">Description</span>             <span class="o">|</span>
 <span class="o">+---------------</span> <span class="o">+---------+---------------------------------------+</span>
 <span class="o">|</span>   <span class="no">Command</span> <span class="no">Name</span> <span class="o">|</span> <span class="no">String</span>  <span class="o">|</span> <span class="no">Name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">command</span><span class="o">.</span> <span class="no">Set</span> <span class="n">to</span> <span class="s2">"connect"</span><span class="o">.|</span>
 <span class="o">+----------------+---------+---------------------------------------+</span>
 <span class="o">|</span> <span class="no">Transaction</span> <span class="no">ID</span> <span class="o">|</span> <span class="no">Number</span>  <span class="o">|</span>            <span class="no">Always</span> <span class="n">set</span> <span class="n">to</span> <span class="mi">1</span><span class="o">.</span>           <span class="o">|</span>
 <span class="o">+----------------+---------+---------------------------------------+</span>
 <span class="o">|</span> <span class="no">Command</span> <span class="no">Object</span> <span class="o">|</span> <span class="no">Object</span>  <span class="o">|</span>  <span class="no">Command</span> <span class="n">information</span> <span class="n">object</span> <span class="n">which</span> <span class="n">has</span> <span class="o">|</span>
 <span class="o">|</span>                <span class="o">|</span>         <span class="o">|</span>           <span class="n">the</span> <span class="nb">name</span><span class="o">-</span><span class="n">value</span> <span class="n">pairs</span><span class="o">.</span>       <span class="o">|</span>
 <span class="o">+----------------+---------+---------------------------------------+</span>
 <span class="o">|</span> <span class="no">Optional</span> <span class="no">User</span>  <span class="o">|</span> <span class="no">Object</span>  <span class="o">|</span>       <span class="no">Any</span> <span class="n">optional</span> <span class="n">information</span>        <span class="o">|</span>
 <span class="o">|</span>   <span class="no">Arguments</span>    <span class="o">|</span>         <span class="o">|</span>                                       <span class="o">|</span>
 <span class="o">+----------------+---------+---------------------------------------+</span>
</pre></td></tr></tbody></table></code></div></div>

<p>RTMP握手之后先发送一个<code class="language-plaintext highlighter-rouge">connect</code>命令消息，命令里面包含什么东西，协议中没有具体规定，实际通信中要携带 rtmp url 中的 <code class="language-plaintext highlighter-rouge">appName</code> 字段，并且指定一些编解码的信息，并以<code class="language-plaintext highlighter-rouge">AMF</code>格式发送, 下面是用wireshake抓取<code class="language-plaintext highlighter-rouge">connect</code>命令需要包含的参数信息：</p>

<ul>
  <li>
    <div class="table-wrapper"><table>
      <tbody>
        <tr>
          <td>![img](https://upload-images.jianshu.io/upload_images/1111194-5dea339938a56f7c.png?imageMogr2/auto-orient/strip</td>
          <td>imageView2/2/w/1200/format/webp)</td>
        </tr>
      </tbody>
    </table></div>

    <p>pic_3.png</p>
  </li>
</ul>

<p>这些信息协议中并没有特别详细说明, 在<code class="language-plaintext highlighter-rouge">librtmp</code>，<code class="language-plaintext highlighter-rouge">srs-librtmp</code>这些源码中，以及用wireshark 抓包的时候可以看到。</p>

<p>服务器返回的是一个_result命令类型消息，这个消息的<code class="language-plaintext highlighter-rouge">payload length</code>一般不会大于<code class="language-plaintext highlighter-rouge">128</code>字节，但是在最新的<code class="language-plaintext highlighter-rouge">nginx-rtmp</code>中返回的消息长度会大于128字节。</p>

<p>消息的<code class="language-plaintext highlighter-rouge">transactionID</code>是用来标识<code class="language-plaintext highlighter-rouge">command</code>类型的消息的，服务器返回的<code class="language-plaintext highlighter-rouge">_result</code>消息可以通过<code class="language-plaintext highlighter-rouge">transactionID</code>来区分是对哪个命令的回应，<code class="language-plaintext highlighter-rouge">connect</code> 命令发完之后还要发送其他命令消息，要保证他们的<code class="language-plaintext highlighter-rouge">transactionID</code>不相同。</p>

<p>发送完<code class="language-plaintext highlighter-rouge">connect</code>命令之后一般会发一个 <code class="language-plaintext highlighter-rouge">set chunk size</code>消息来设置<code class="language-plaintext highlighter-rouge">chunk size</code>的大小，也可以不发。</p>

<p><code class="language-plaintext highlighter-rouge">Window Acknowledgement Size</code> 是设置接收端消息窗口大小，一般是<code class="language-plaintext highlighter-rouge">2500000</code>字节，即告诉对端在收到设置的窗口大小长度的数据之后要返回一个<code class="language-plaintext highlighter-rouge">ACK</code>消息。在实际做推流的时候推流端要接收很少的服务器数据，远远到达不了窗口大小，所以这个消息可以不发。而对于服务器返回的<code class="language-plaintext highlighter-rouge">ACK</code>消息一般也不做处理，默认服务器都已经收到了所有消息了。</p>

<p>之后要等待服务器对于<code class="language-plaintext highlighter-rouge">connect</code>消息的回应的，一般是把服务器返回的<code class="language-plaintext highlighter-rouge">chunk</code>都读完，组包成完整的<code class="language-plaintext highlighter-rouge">RTMP</code>消息，没有错误就可以进行下一步了。</p>

<h5 id="322-create-stream-消息"><span class="mr-2"><strong>3.2.2</strong> <strong>Create Stream 消息</strong></span><a href="#322-create-stream-消息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>创建完<code class="language-plaintext highlighter-rouge">RTMP</code>连接之后就可以创建<code class="language-plaintext highlighter-rouge">RTMP</code>流，客户端要想服务器发送一个<code class="language-plaintext highlighter-rouge">releaseStream</code>命令消息，之后是<code class="language-plaintext highlighter-rouge">FCPublish</code>命令消息，在之后是<code class="language-plaintext highlighter-rouge">createStream</code>命令消息。</p>

<p>当发送完<code class="language-plaintext highlighter-rouge">createStream</code>消息之后，解析服务器返回的消息会得到一个<code class="language-plaintext highlighter-rouge">stream ID</code>。</p>

<ul>
  <li>
    <div class="table-wrapper"><table>
      <tbody>
        <tr>
          <td>![img](https://upload-images.jianshu.io/upload_images/1111194-f370aee91bc73c2d.png?imageMogr2/auto-orient/strip</td>
          <td>imageView2/2/w/1200/format/webp)</td>
        </tr>
      </tbody>
    </table></div>

    <p>pic_4.png</p>
  </li>
</ul>

<p>这个ID也就是以后和服务器通信的 <code class="language-plaintext highlighter-rouge">message stream ID</code>, 一般返回的是1，不固定。</p>

<h5 id="323-publish-stream"><span class="mr-2"><strong>3.2.3</strong> <strong>Publish Stream</strong></span><a href="#323-publish-stream" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>推流准备工作的最后一步是<code class="language-plaintext highlighter-rouge">Publish Stream</code>，即向服务器发一个<code class="language-plaintext highlighter-rouge">publish</code>命令消息，消息中会带有流名称字段，即rtmp url中的 <code class="language-plaintext highlighter-rouge">streamName</code>，这个命令的<code class="language-plaintext highlighter-rouge">message stream ID</code> 就是上面 <code class="language-plaintext highlighter-rouge">create stream</code> 之后服务器返回的<code class="language-plaintext highlighter-rouge">stream ID</code>，发完这个命令一般不用等待服务器返回的回应，直接发送音视频类型的RTMP数据包即可。有些rtmp库还会发<code class="language-plaintext highlighter-rouge">setMetaData</code>消息，这个消息可以发也可以不发，里面包含了一些音视频<code class="language-plaintext highlighter-rouge">meta data</code>的信息，如视频的分辨率等等。</p>

<p><strong>整个推流过程rtmp 消息抓包</strong></p>

<ul>
  <li>
    <div class="table-wrapper"><table>
      <tbody>
        <tr>
          <td>![img](https://upload-images.jianshu.io/upload_images/1111194-2fcba45b9234e725.png?imageMogr2/auto-orient/strip</td>
          <td>imageView2/2/w/1200/format/webp)</td>
        </tr>
      </tbody>
    </table></div>

    <p>rtmp_pulish_message.png</p>
  </li>
</ul>

<h3 id="4-推送音视频"><span class="mr-2"><strong>4. 推送音视频</strong></span><a href="#4-推送音视频" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>当以上工作都完成的时候，就可以发送音视频了。音视频RTMP消息的Payload(消息体)中都放的是按照<code class="language-plaintext highlighter-rouge">FLV-TAG</code>格式封的音视频包，具体可以参照<code class="language-plaintext highlighter-rouge">FLV</code>封装的协议文档。格式必须封装正确，否则会造成播放端不能正常拿到音视频数据，无法播放音视频。</p>

<h3 id="5-关于rtmp的时间戳"><span class="mr-2"><strong>5. 关于RTMP的时间戳</strong></span><a href="#5-关于rtmp的时间戳" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>RTMP的时间戳单位是毫秒<code class="language-plaintext highlighter-rouge">ms</code>，在发送音视频之前一直为零，发送音视频消息包后时候必须保证时间戳是单调递增的，时间戳必须打准确，否则播放端可能出现音视频不同步的情况。Srs-librtmp的源码中，如果推的是视频文件的话，发现他们是用H264的<code class="language-plaintext highlighter-rouge">dts</code>作为时间戳的。实时音视频传输的时候是先获取了下某一时刻系统时间作为基准，然后每次相机采集到的视频包，与起始的基准时间相减，得到时间戳，这样可以保证时间戳的正确性。</p>

<h3 id="6-关于chunk-stream-id"><span class="mr-2"><strong>6. 关于Chunk Stream ID</strong></span><a href="#6-关于chunk-stream-id" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>RTMP 的<code class="language-plaintext highlighter-rouge">Chunk Steam ID</code>是用来区分某一个chunk是属于哪一个<code class="language-plaintext highlighter-rouge">message</code>的 ，0和1是保留的。每次在发送一个不同类型的RTMP消息时都要有不用的chunk stream ID, 如上一个Message 是command类型的，之后要发送视频类型的消息，视频消息的<code class="language-plaintext highlighter-rouge">chunk stream ID</code> 要保证和上面 <code class="language-plaintext highlighter-rouge">command</code>类型的消息不同。每一种消息类型的起始chunk 的类型必须是 <code class="language-plaintext highlighter-rouge">Type_0</code> 类型的，表明新的消息的起始。</p>

<h3 id="总结"><span class="mr-2"><strong>总结：</strong></span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>RTMP协议是个比较啰嗦的协议，实现起来也比较复杂，但通信过程过程相对简单。在直播的实际工程应用中，协议上很多地方都没有详细说明，注意了以上提到几点，基本能够保证RTMP音视频的通信正常。以上就是对RTMP协议的简介和一些注意事项，希望能帮到有需要的朋友，另外本文难免有错误或说的不够详细的地方，欢迎指正，一起交流探讨。</p>

<hr />

<h3 id="本篇文章2017年版本"><span class="mr-2">本篇文章2017年版本</span><a href="#本篇文章2017年版本" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>前一段时间写过一篇文章: <a href="https://www.jianshu.com/p/337830891996">iOS直播视频数据采集、硬编码保存h264文件</a>，比较详细的记录了在做iOS端进行视频数据采集和编码的过程，下一步要做的就是RTMP协议推流。因为在公司将RTMP协议用Java 和 Swift 分别实现了一遍，所以对这块比较了解，中间遇到了不少坑，记录下来也怕自己忘掉。
RTMP协议是 Adobe 公司开发的一个基于TCP的应用层协议，Adobe 公司也公布了关于RTMP的规范，但是这个协议规范介绍的有些地方非常模糊，很多东西和实际应用是有差别的。网上也有不少关于这个协议的介绍，但都不是太详细。我遇到的比较好的参考资料就是这篇：<a href="https://links.jianshu.com/go?to=http%3A%2F%2Fmingyangshang.github.io%2F2016%2F03%2F06%2FRTMP%E5%8D%8F%E8%AE%AE%2F">带你吃透RTMP</a>, 这篇文章只是在理论上对RTMP进行了比较详细的解释，很多东西还是和实际应用有出入。我这篇文章只是把遇到的一些坑记录下来，并不是详解RTMP消息的。
另外懂RTMP消息拆包分包，而不真正的写写的话是很难把RTMP协议弄得的很清楚，关于RTMP协议的实现也是比较麻烦的事，懂和做事两回事。
另外用wireshark 抓一下包的话可以非常直观的看到RTMP通信的过程，对理解RTMP非常有帮助，在调试代码的时候也大量借助wireshark排错，是一个非常有用的工具。</p>

<h3 id="1-rtmp-握手"><span class="mr-2">1. RTMP 握手</span><a href="#1-rtmp-握手" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>RTMP 握手分为简单握手和复杂握手，现在Adobe公司使用RTMP协议的产品应该用的都是复杂握手，这里不介绍，只说简单握手。 按照网上的说法RTMP握手的过程如下</p>

<blockquote>
  <ol>
    <li>握手开始于客户端发送C0、C1块。服务器收到C0或C1后发送S0和S1。</li>
  </ol>
</blockquote>

<ol>
  <li>当客户端收齐S0和S1后，开始发送C2。当服务器收齐C0和C1后，开始发送S2。</li>
  <li>当客户端和服务器分别收到S2和C2后，握手完成。</li>
</ol>

<p>在实际工程应用中，一般是客户端先将<code class="language-plaintext highlighter-rouge">C0</code>, <code class="language-plaintext highlighter-rouge">C1</code>块同时发出，服务器在收到<code class="language-plaintext highlighter-rouge">C1</code> 之后同时将<code class="language-plaintext highlighter-rouge">S0</code>, <code class="language-plaintext highlighter-rouge">S1</code>, <code class="language-plaintext highlighter-rouge">S2</code>发给客户端。S2的内容就是收到的C1块的内容。之后客户端收到S1块，并原样返回给服务器，简单握手完成。按照RTMP协议个要求，客户端需要校验C1块的内容和S2块的内容是否相同，相同的话才彻底完成握手过程，实际编写程序用一般都不去做校验。
RTMP握手的这个过程就是完成了两件事：1. 校验客户端和服务器端RTMP协议版本号，2. 是发了一堆数据，猜想应该是测试一下网络状况，看看有没有传错或者不能传的情况。RTMP握手是整个RTMP协议中最容易实现的一步，接下来才是大头。</p>

<h3 id="2-rtmp-分块"><span class="mr-2">2. RTMP 分块</span><a href="#2-rtmp-分块" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>创建RTMP连接算是比较难的地方，开始涉及消息分块（chunking）和 AFM（也是Adobe家的东西）格式数据的一些东西，在上面提到的文章中也有介绍为什要进行RTMP分块。</p>

<h4 id="chunk-size"><span class="mr-2">Chunk Size</span><a href="#chunk-size" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>RTMP是按照chunk size进行分块，chunk size指的是 chunk的payload部分的大小，不包括chunk basic header 和 chunk message header，即chunk的body的大小。客户端和服务器端各自维护了两个chunk size, 分别是自身分块的chunk size 和 对端 的chunk size, 默认的这两个chunk size都是128字节。通过向对端发送<code class="language-plaintext highlighter-rouge">set chunk size</code> 消息告知对方更改了 chunk size的大小，即告诉对端：我接下来要以xxx个字节拆分RTMP消息，你在接收到消息的时候就按照新的chunk size 来组包。
在实际写代码的时候一般会把chunk size设置的很大，有的会设置为4096，FFMPEG推流的时候设置的是 60*1000，这样设置的好处是避免了频繁的拆包组包，占用过多的CPU。设置太大的话也不好，一个很大的包如果发错了，或者丢失了，播放端就会出现长时间的花屏或者黑屏等现象。</p>

<h4 id="chunk-type"><span class="mr-2">Chunk Type</span><a href="#chunk-type" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>RTMP 分成的Chunk有4中类型，可以通过 chunk basic header的 高两位指定，一般在拆包的时候会把一个RTMP消息拆成以 Type_0 类型开始的chunk，之后的包拆成 Type_3 类型的chunk，我查看了有不少代码也是这样实现的，这样也是最简单的实现。
RTMP 中关于Message 分chunk只举了两个例子，这两个例子不是很具有代表性。假如第二个message和第一个message的message stream ID 相同，并且第二个message的长度也大于了chunk size，那么该如何拆包？当时查了很多资料，都没有介绍。后来看了一些源码，发现第二个message可以拆成Type_1类型一个chunk, message剩余的部分拆成Type_3类型的chunk。FFMPEG中好像就是这么做的。</p>

<h3 id="3-rtmp-消息-1"><span class="mr-2">3. RTMP 消息</span><a href="#3-rtmp-消息-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>关于推流的过程，RTMP的协议文档上给了一个示例，而真实的RTMP通信过程和它有较大的差异，只说推流，RTMP播放端我没有做过。</p>

<h4 id="connect消息"><span class="mr-2">Connect消息</span><a href="#connect消息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>握手之后先发送一个connect 命令消息，命令里面包含什么东西，协议中没有说，真实通信中要指定一些编解码的信息，这些信息是以AMF格式发送的, 下面是用swift 写的connect命令包含的参数信息：</p>

<div class="language-csharp highlighter-rouge"><div class="code-header">
        <span data-label-text="C#"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>       <span class="n">transactionID</span> <span class="p">+=</span> <span class="m">1</span> <span class="c1">// 0x01</span>
        <span class="k">let</span> <span class="n">command</span><span class="p">:</span><span class="n">RTMPCommandMessage</span> <span class="p">=</span> <span class="nf">RTMPCommandMessage</span><span class="p">(</span><span class="n">commandName</span><span class="p">:</span> <span class="s">"connect"</span><span class="p">,</span> <span class="n">transactionId</span><span class="p">:</span> <span class="n">transactionID</span><span class="p">,</span> <span class="n">messageStreamId</span><span class="p">:</span> <span class="m">0x00</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">objects</span><span class="p">:</span><span class="n">Amf0Object</span> <span class="p">=</span> <span class="nf">Amf0Object</span><span class="p">()</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"app"</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="n">rtmpSocket</span><span class="p">.</span><span class="n">appName</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"flashVer"</span><span class="p">,</span><span class="k">value</span><span class="p">:</span> <span class="s">"FMLE/3.0 (compatible; FMSc/1.0)"</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"swfUrl"</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span><span class="s">""</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"tcUrl"</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">"rtmp://"</span> <span class="p">+</span> <span class="n">rtmpSocket</span><span class="p">.</span><span class="n">hostname</span> <span class="p">+</span> <span class="s">"/"</span> <span class="p">+</span> <span class="n">rtmpSocket</span><span class="p">.</span><span class="n">appName</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"fpad"</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"capabilities"</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span><span class="m">239</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"audioCodecs"</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span><span class="m">3575</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"videoCodecs"</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span><span class="m">252</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"videoFunction"</span><span class="p">,</span><span class="k">value</span><span class="p">:</span> <span class="m">1</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"pageUrl"</span><span class="p">,</span><span class="k">value</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>
        <span class="n">objects</span><span class="p">.</span><span class="nf">setProperties</span><span class="p">(</span><span class="s">"objectEncoding"</span><span class="p">,</span><span class="k">value</span><span class="p">:</span> <span class="m">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>这些信息具体什么意思我也不太明白，协议中也没有，都是我在看librtmp，srs-librtmp这些源码，以及用wireshark 抓包的时候看到的。其中参数少一两个貌似也没问题，但是<code class="language-plaintext highlighter-rouge">audioCodecs</code>和<code class="language-plaintext highlighter-rouge">videoCodecs</code>这两个指定音视频编码信息的不能少。
服务器返回的是一个_result命令类型消息，这个消息的payload length一般不会大于128字节，但是在最新的nginx-rtmp中返回的消息长度会大于128字节，所以一定要做好收包，组包的工作。
关于消息的transactionID是用来标识command类型的消息的，服务器返回的_result消息可以通过 transactionID来区分是对哪个命令的回应，connect 命令发完之后还要发送其他命令消息，要保证他们的transactionID不相同。
发送完connect命令之后一般会发一个 set chunk size消息来设置chunk size 的大小，也可以不发。
Window Acknowledgement Size 是设置接收端消息窗口大小，一般是2500000字节，即告诉客户端你在收到我设置的窗口大小的这么多数据之后给我返回一个ACK消息，告诉我你收到了这么多消息。在实际做推流的时候推流端要接收很少的服务器数据，远远到达不了窗口大小，所以基本不用考虑这点。而对于服务器返回的ACK消息一般也不做处理，我们默认服务器都已经收到了这么多消息。
之后要等待服务器对于connect的回应的，一般是把服务器返回的chunk都读完组成完整的RTMP消息，没有错误就可以进行下一步了。</p>

<h4 id="create-stream-消息"><span class="mr-2">Create Stream 消息</span><a href="#create-stream-消息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>创建完RTMP连接之后就可以创建RTMP流，客户端要想服务器发送一个<code class="language-plaintext highlighter-rouge">releaseStream</code>命令消息，之后是<code class="language-plaintext highlighter-rouge">FCPublish</code>命令消息，在之后是<code class="language-plaintext highlighter-rouge">createStream</code>命令消息。当发送完<code class="language-plaintext highlighter-rouge">createStream</code>消息之后，解析服务器返回的消息会得到一个<code class="language-plaintext highlighter-rouge">stream ID</code>, 这个ID也就是以后和服务器通信的 <code class="language-plaintext highlighter-rouge">message stream ID</code>, 一般返回的是1，不固定。</p>

<h4 id="publish-stream"><span class="mr-2">Publish Stream</span><a href="#publish-stream" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>推流准备工作的最后一步是 Publish Stream，即向服务器发一个<code class="language-plaintext highlighter-rouge">publish</code>命令，这个命令的message stream ID 就是上面 create stream 之后服务器返回的stream ID，发完这个命令一般不用等待服务器返回的回应，直接下一步发送音视频数据。有些rtmp库 还会发<code class="language-plaintext highlighter-rouge">setMetaData</code>消息，这个消息可以发也可以不发，里面包含了一些音视频编码的信息。</p>

<h3 id="4-发布音视频"><span class="mr-2">4. 发布音视频</span><a href="#4-发布音视频" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>当以上工作都完成的时候，就可以发送音视频了。音视频RTMP消息的Payload中都放的是按照FLV-TAG格式封的音视频包，具体可以参照FLV协议文档。</p>

<h3 id="5-关于rtmp的时间戳-1"><span class="mr-2">5. 关于RTMP的时间戳</span><a href="#5-关于rtmp的时间戳-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>RTMP的时间戳在发送音视频之前都为零，开始发送音视频消息的时候只要保证时间戳是单增的基本就可以正常播放音视频。我读Srs-librtmp的源码，发现他们是用h264的dts作为时间戳的。我在用java写的时候是先获取了下当前系统时间，然后每次发送消息的时候都与这个起始时间相减，得到时间戳。</p>

<h3 id="6-关于chunk-stream-id-1"><span class="mr-2">6. 关于Chunk Stream ID</span><a href="#6-关于chunk-stream-id-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>RTMP 的Chunk Steam ID是用来区分某一个chunk是属于哪一个message的 ,0和1是保留的。每次在发送一个不同类型的RTMP消息时都要有不用的chunk stream ID, 如上一个Message 是command类型的，之后要发送视频类型的消息，视频消息的chunk stream ID 要保证和上面 command类型的消息不同。每一种消息类型的起始chunk 的类型必须是 Type_0 类型的，表明我是一个新的消息的起始。</p>

<hr />

<p>另外这篇文章有些地方还是说的模糊，以后有时间慢慢丰富吧。</p>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/'>技术笔记</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/%E7%9B%B4%E6%92%AD/"
          class="post-tag no-text-decoration" >直播</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        本文由作者按照 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         进行授权

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">分享</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=RTMP直播协议实践经验总结 - 拙巧匠&url=https%3A%2F%2Ffifo.site%2Fposts%2FSummary-of-the-rtmp-experience%2F" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=RTMP直播协议实践经验总结 - 拙巧匠&u=https%3A%2F%2Ffifo.site%2Fposts%2FSummary-of-the-rtmp-experience%2F" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=https%3A%2F%2Ffifo.site%2Fposts%2FSummary-of-the-rtmp-experience%2F&text=RTMP直播协议实践经验总结 - 拙巧匠" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="分享链接"
        data-title-succeed="链接已复制！">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- panel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">最近更新</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/posts/webrtc-Mac-M1-compile/">WebRTC 编译</a></li>
      
        
        
        
      <li><a href="/posts/MacOS-Big-Sur_GN_WebRTC_iOS_error/">升级MacOS Big Sur后GN生成WebRTC-iOS工程报错</a></li>
      
        
        
        
      <li><a href="/posts/dong-gua-dun-rou/">防疫居家，冬瓜炖肉</a></li>
      
        
        
        
      <li><a href="/posts/Thinking_about_the_problem/">对于问题的思考</a></li>
      
        
        
        
      <li><a href="/posts/text-and-typography/">text-and-typography</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">热门标签</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a>
    
      
      <a class="post-tag" href="/tags/webrtc/">WebRTC</a>
    
      
      <a class="post-tag" href="/tags/opengl/">OpenGL</a>
    
      
      <a class="post-tag" href="/tags/android/">Android</a>
    
      
      <a class="post-tag" href="/tags/ffmpeg/">ffmpeg</a>
    
      
      <a class="post-tag" href="/tags/ffmpeg/">FFmpeg</a>
    
      
      <a class="post-tag" href="/tags/git/">git</a>
    
      
      <a class="post-tag" href="/tags/typography/">typography</a>
    
      
      <a class="post-tag" href="/tags/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/">技术笔记</a>
    
      
      <a class="post-tag" href="/tags/%E7%9B%B4%E6%92%AD/">直播</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">文章内容</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5">
    
      
      <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->





  <div id="related-posts" class="mb-2 mb-sm-4">
    <h3 class="pt-2 mb-4 ml-1"
      data-toc-skip>相关文章</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/Compile-ffmpeg-4.2.1-for-mac-os-with-openssl/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1660127460"
    data-df="YYYY/MM/DD"
    >
  2022/08/10
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Compile ffmpeg 4.2.1 for mac os with openssl</h3>
            <div class="text-muted small">
              <p>
                





                编译环境：mac os x 10.15.3 ， ffmpeg 4.2.1

1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
./configure --target-os=dar...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/webrtc_pacedsender/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1660127700"
    data-df="YYYY/MM/DD"
    >
  2022/08/10
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>WebRTC中PacedSender工作原理和代码分析</h3>
            <div class="text-muted small">
              <p>
                





                摘抄一段 PacedSender 简介，下面的链接对该模块的工作原理做了详细的介绍，今天大致看了下这个模块的代码，记录一下


  在estimator根据网络状态决策出新的通信码率（target bitrate），它会将这个码率设置到pacer当中，要求pacer按照新的码率来计算发包频率。因为在视频通信中，单帧视频可能有上百KB,如果是当视频帧被编码器编码出来后，就立即进行RTP打包发送...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/Android%E8%B8%A9%E5%9D%91-Failed-to-create-EGL-context-0x3003/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1660127940"
    data-df="YYYY/MM/DD"
    >
  2022/08/10
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android踩坑 Failed to create EGL context:0x3003</h3>
            <div class="text-muted small">
              <p>
                





                情况1：

最近线上Android 线上App有大量用户报

Failed to create EGL context: 0x3003


opengl context 创建代码，崩溃的地为 Failed to create EGL context: 0x处：

1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
  // Return an EG...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


    
      
      <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/Git_Commit_Specification/" class="btn btn-outline-primary"
    prompt="上一篇">
    <p>Git开发流程规范</p>
  </a>
  

  
  <a href="/posts/MacOS-Big-Sur_GN_WebRTC_iOS_error/" class="btn btn-outline-primary"
    prompt="下一篇">
    <p>升级MacOS Big Sur后GN生成WebRTC-iOS工程报错</p>
  </a>
  

</div>

    
      
      <!--  The comments switcher -->

  
  <!-- https://giscus.app/ -->
<script type="text/javascript">
  $(function () {
    const origin = "https://giscus.app";
    const iframe = "iframe.giscus-frame";
    const lightTheme = "light";
    const darkTheme = "dark_dimmed";
    let initTheme = lightTheme;

    if ($("html[data-mode=dark]").length > 0
        || ($("html[data-mode]").length == 0
            && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
      initTheme = darkTheme;
    }

    let giscusAttributes = {
      "src": "https://giscus.app/client.js",
      "data-repo": "gezhaoyou/blog-comments",
      "data-repo-id": "MDEwOlJlcG9zaXRvcnkzMjcxNjU1NDc=",
      "data-category": "General",
      "data-category-id": "DIC_kwDOE4Ama84CQupv",
      "data-mapping": "url",
      "data-reactions-enabled": "1",
      "data-emit-metadata": "0",
      "data-theme": initTheme,
      "data-input-position": "top",
      "data-lang": "zh-CN",
      "crossorigin": "anonymous",
      "async": ""
    };

    let giscusScript = document.createElement("script");
    Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
    document.getElementById("tail-wrapper").appendChild(giscusScript);

    addEventListener("message", (event) => {
      if (event.source === window && event.data &&
            event.data.direction === ModeToggle.ID) {
        /* global theme mode changed */
        const mode = event.data.message;
        const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme);

        const message = {
          setConfig: {
            theme: theme
          }
        };

        const giscus = document.querySelector(iframe).contentWindow;
        giscus.postMessage({ giscus: message }, origin);
      }

    });

  });
</script>



    
  </div>
</div>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">热门标签</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a>
    
      
      <a class="post-tag" href="/tags/webrtc/">WebRTC</a>
    
      
      <a class="post-tag" href="/tags/opengl/">OpenGL</a>
    
      
      <a class="post-tag" href="/tags/android/">Android</a>
    
      
      <a class="post-tag" href="/tags/ffmpeg/">ffmpeg</a>
    
      
      <a class="post-tag" href="/tags/ffmpeg/">FFmpeg</a>
    
      
      <a class="post-tag" href="/tags/git/">git</a>
    
      
      <a class="post-tag" href="/tags/typography/">typography</a>
    
      
      <a class="post-tag" href="/tags/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/">技术笔记</a>
    
      
      <a class="post-tag" href="/tags/%E7%9B%B4%E6%92%AD/">直播</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    <!-- The Footer -->

<footer>
  <div class="container pl-lg-4 pr-lg-4">
    <div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3">
      <div class="footer-left">
        <p class="mb-0">
          <!-- 网站备案信息 -->
          <a href="https://beian.miit.gov.cn" target="_blank" rel="noopener">京ICP备2023001817号 </a>
          
          © 2023
          <a href="https://github.com/gezhaoyou">zhaoyou</a>.
          
          <span data-toggle="tooltip" data-placement="top"
            title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span>
          
        </p>
      </div>

      <div class="footer-right">
        <p class="mb-0">本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。
        </p>
      </div>
    </div>
  </div>
</footer>


    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
        data-animation="true" data-autohide="false">
        <div class="toast-header">
          <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="pl-2 pr-2 mb-3">发现新版本的内容。</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            更新
          </button>
        </div>
      </div>
    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">搜索结果为空</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script>






  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/zh.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

